!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Datafeeds={})}(this,function(e){"use strict";function t(e){}function s(e){return void 0===e?"":"string"==typeof e?e:e.message}function r(e,t,s,r){let i=e[t];return Array.isArray(i)&&(!r||Array.isArray(i[0]))?i[s]:i}function i(e,t,s){return e+(void 0!==t?"_%|#|%_"+t:"")+(void 0!==s?"_%|#|%_"+s:"")}class o{constructor(e,t,s){this._exchangesList=["NYSE","FOREX","AMEX"],this._symbolsInfo={},this._symbolsList=[],this._datafeedUrl=e,this._datafeedSupportedResolutions=t,this._requester=s,this._readyPromise=this._init(),this._readyPromise.catch(e=>{console.error(`SymbolsStorage: Cannot init, error=${e.toString()}`)})}resolveSymbol(e,t,s){return this._readyPromise.then(()=>{let r=this._symbolsInfo[i(e,t,s)];return void 0===r?Promise.reject("invalid symbol"):Promise.resolve(r)})}searchSymbols(e,t,s,r){return this._readyPromise.then(()=>{let i=[],o=0===e.length;for(let n of(e=e.toUpperCase(),this._symbolsList)){let a=this._symbolsInfo[n];if(void 0===a||s.length>0&&a.type!==s||t&&t.length>0&&a.exchange!==t)continue;let u=a.name.toUpperCase().indexOf(e),l=a.description.toUpperCase().indexOf(e);if(o||u>=0||l>=0){let h=i.some(e=>e.symbolInfo===a);if(!h){let d=u>=0?u:8e3+l;i.push({symbolInfo:a,weight:d})}}}let c=i.sort((e,t)=>e.weight-t.weight).slice(0,r).map(e=>{let t=e.symbolInfo;return{symbol:t.name,full_name:t.full_name,description:t.description,exchange:t.exchange,params:[],type:t.type,ticker:t.name}});return Promise.resolve(c)})}_init(){let e=[],t={};for(let s of this._exchangesList)!t[s]&&(t[s]=!0,e.push(this._requestExchangeData(s)));return Promise.all(e).then(()=>{this._symbolsList.sort()})}_requestExchangeData(e){return new Promise((r,i)=>{this._requester.sendRequest(this._datafeedUrl,"symbol_info",{group:e}).then(t=>{try{this._onExchangeDataReceived(e,t)}catch(s){i(s instanceof Error?s:Error(`SymbolsStorage: Unexpected exception ${s}`));return}r()}).catch(i=>{t(`SymbolsStorage: Request data for exchange '${e}' failed, reason=${s(i)}`),r()})})}_onExchangeDataReceived(e,t){let s=0;try{let o=t.symbol.length,a=void 0!==t.ticker;for(;s<o;++s){let u=t.symbol[s],l=r(t,"exchange-listed",s),h=r(t,"exchange-traded",s),d=h+":"+u,c=r(t,"currency-code",s),m=r(t,"unit-id",s),f=a?r(t,"ticker",s):u,b={ticker:f,name:u,base_name:[l+":"+u],full_name:d,listed_exchange:l,exchange:h,currency_code:c,original_currency_code:r(t,"original-currency-code",s),unit_id:m,original_unit_id:r(t,"original-unit-id",s),unit_conversion_types:r(t,"unit-conversion-types",s,!0),description:r(t,"description",s),has_intraday:n(r(t,"has-intraday",s),!1),has_no_volume:n(r(t,"has-no-volume",s),void 0),visible_plots_set:n(r(t,"visible-plots-set",s),void 0),minmov:r(t,"minmovement",s)||r(t,"minmov",s)||0,minmove2:r(t,"minmove2",s)||r(t,"minmov2",s),fractional:r(t,"fractional",s),pricescale:r(t,"pricescale",s),type:r(t,"type",s),session:r(t,"session-regular",s),session_holidays:r(t,"session-holidays",s),corrections:r(t,"corrections",s),timezone:r(t,"timezone",s),supported_resolutions:n(r(t,"supported-resolutions",s,!0),this._datafeedSupportedResolutions),has_daily:n(r(t,"has-daily",s),!0),intraday_multipliers:n(r(t,"intraday-multipliers",s,!0),["1","5","15","30","60"]),has_weekly_and_monthly:r(t,"has-weekly-and-monthly",s),has_empty_bars:r(t,"has-empty-bars",s),volume_precision:n(r(t,"volume-precision",s),0),format:"price"};this._symbolsInfo[f]=b,this._symbolsInfo[u]=b,this._symbolsInfo[d]=b,(void 0!==c||void 0!==m)&&(this._symbolsInfo[i(f,c,m)]=b,this._symbolsInfo[i(u,c,m)]=b,this._symbolsInfo[i(d,c,m)]=b),this._symbolsList.push(u)}}catch(p){throw Error(`SymbolsStorage: API error when processing exchange ${e} symbol #${s} (${t.symbol[s]}): ${Object(p).message}`)}}}function n(e,t){return void 0!==e?e:t}function a(e,t,s){let r=e[t];return Array.isArray(r)?r[s]:r}class u{constructor(e,r,i,o=1e4){this._configuration=l(),this._symbolsStorage=null,this._datafeedURL=e,this._requester=i,this._historyProvider=new class e{constructor(e,t){this._datafeedUrl=e,this._requester=t}getBars(e,t,r){let i={symbol:e.ticker||"",resolution:t,from:r.from,to:r.to};return void 0!==r.countBack&&(i.countback=r.countBack),void 0!==e.currency_code&&(i.currencyCode=e.currency_code),void 0!==e.unit_id&&(i.unitId=e.unit_id),new Promise((e,t)=>{this._requester.sendRequest(this._datafeedUrl,"history",i).then(s=>{if("ok"!==s.s&&"no_data"!==s.s){t(s.errmsg);return}let r=[],i={noData:!1};if("no_data"===s.s)i.noData=!0,i.nextTime=s.nextTime;else{let o=void 0!==s.v,n=void 0!==s.o;for(let a=0;a<s.t.length;++a){let u={time:1e3*s.t[a],close:parseFloat(s.c[a]),open:parseFloat(s.c[a]),high:parseFloat(s.c[a]),low:parseFloat(s.c[a])};n&&(u.open=parseFloat(s.o[a]),u.high=parseFloat(s.h[a]),u.low=parseFloat(s.l[a])),o&&(u.volume=parseFloat(s.v[a])),r.push(u)}}e({bars:r,meta:i})}).catch(e=>{let r=s(e);console.warn(`HistoryProvider: getBars() failed, error=${r}`),t(r)})})}}(e,this._requester),this._quotesProvider=r,this._dataPulseProvider=new class e{constructor(e,t){this._subscribers={},this._requestsPending=0,this._historyProvider=e,setInterval(this._updateData.bind(this),t)}subscribeBars(e,s,r,i){!this._subscribers.hasOwnProperty(i)&&(this._subscribers[i]={lastBarTime:null,listener:r,resolution:s,symbolInfo:e},t(`DataPulseProvider: subscribed for #${i} - {${e.name}, ${s}}`))}unsubscribeBars(e){delete this._subscribers[e]}_updateData(){if(!(this._requestsPending>0))for(let e in this._requestsPending=0,this._subscribers)this._requestsPending+=1,this._updateDataForSubscriber(e).then(()=>{this._requestsPending-=1,t(`DataPulseProvider: data for #${e} updated successfully, pending=${this._requestsPending}`)}).catch(r=>{this._requestsPending-=1,t(`DataPulseProvider: data for #${e} updated with error=${s(r)}, pending=${this._requestsPending}`)})}_updateDataForSubscriber(e){var t,s=10;let r,i=this._subscribers[e],o=parseInt((Date.now()/1e3).toString()),n=o-(t=i.resolution,r=0,86400*(r="D"===t||"1D"===t?s:"M"===t||"1M"===t?31*s:"W"===t||"1W"===t?7*s:s*parseInt(t)/1440));return this._historyProvider.getBars(i.symbolInfo,i.resolution,{from:n,to:o,countBack:2,firstDataRequest:!1}).then(t=>{this._onSubscriberDataReceived(e,t)})}_onSubscriberDataReceived(e,t){if(!this._subscribers.hasOwnProperty(e))return;let s=t.bars;if(0===s.length)return;let r=s[s.length-1],i=this._subscribers[e];if(null!==i.lastBarTime&&r.time<i.lastBarTime)return;let o=null!==i.lastBarTime&&r.time>i.lastBarTime;if(o){if(s.length<2)throw Error("Not enough bars in history for proper pulse update. Need at least 2.");let n=s[s.length-2];i.listener(n)}i.lastBarTime=r.time,i.listener(r)}}(this._historyProvider,o),this._quotesPulseProvider=new class e{constructor(e){this._subscribers={},this._requestsPending=0,this._quotesProvider=e,setInterval(this._updateQuotes.bind(this,1),1e4),setInterval(this._updateQuotes.bind(this,0),6e4)}subscribeQuotes(e,t,s,r){this._subscribers[r]={symbols:e,fastSymbols:t,listener:s}}unsubscribeQuotes(e){delete this._subscribers[e]}_updateQuotes(e){if(!(this._requestsPending>0))for(let r in this._subscribers){this._requestsPending++;let i=this._subscribers[r];this._quotesProvider.getQuotes(1===e?i.fastSymbols:i.symbols).then(s=>{this._requestsPending--,this._subscribers.hasOwnProperty(r)&&(i.listener(s),t(`QuotesPulseProvider: data for #${r} (${e}) updated successfully, pending=${this._requestsPending}`))}).catch(i=>{this._requestsPending--,t(`QuotesPulseProvider: data for #${r} (${e}) updated with error=${s(i)}, pending=${this._requestsPending}`)})}}}(this._quotesProvider),this._configurationReadyPromise=this._requestConfiguration().then(e=>{null===e&&(e=l()),this._setupWithConfiguration(e)})}onReady(e){this._configurationReadyPromise.then(()=>{e(this._configuration)})}getQuotes(e,t,s){this._quotesProvider.getQuotes(e).then(t).catch(s)}subscribeQuotes(e,t,s,r){this._quotesPulseProvider.subscribeQuotes(e,t,s,r)}unsubscribeQuotes(e){this._quotesPulseProvider.unsubscribeQuotes(e)}getMarks(e,r,i,o,n){if(!this._configuration.supports_marks)return;let u={symbol:e.ticker||"",from:r,to:i,resolution:n};this._send("marks",u).then(e=>{if(!Array.isArray(e)){let t=[];for(let s=0;s<e.id.length;++s)t.push({id:a(e,"id",s),time:a(e,"time",s),color:a(e,"color",s),text:a(e,"text",s),label:a(e,"label",s),labelFontColor:a(e,"labelFontColor",s),minSize:a(e,"minSize",s)});e=t}o(e)}).catch(e=>{t(`UdfCompatibleDatafeed: Request marks failed: ${s(e)}`),o([])})}getTimescaleMarks(e,r,i,o,n){if(!this._configuration.supports_timescale_marks)return;let u={symbol:e.ticker||"",from:r,to:i,resolution:n};this._send("timescale_marks",u).then(e=>{if(!Array.isArray(e)){let t=[];for(let s=0;s<e.id.length;++s)t.push({id:a(e,"id",s),time:a(e,"time",s),color:a(e,"color",s),label:a(e,"label",s),tooltip:a(e,"tooltip",s)});e=t}o(e)}).catch(e=>{t(`UdfCompatibleDatafeed: Request timescale marks failed: ${s(e)}`),o([])})}getServerTime(e){this._configuration.supports_time&&this._send("time").then(t=>{let s=parseInt(t);isNaN(s)||e(s)}).catch(e=>{t(`UdfCompatibleDatafeed: Fail to load server time, error=${s(e)}`)})}searchSymbols(e,r,i,o){if(this._configuration.supports_search){let n={limit:30,query:e.toUpperCase(),type:i,exchange:r};this._send("search",n).then(e=>{if(void 0!==e.s){t(`UdfCompatibleDatafeed: search symbols error=${e.errmsg}`),o([]);return}o(e)}).catch(r=>{t(`UdfCompatibleDatafeed: Search symbols for '${e}' failed. Error=${s(r)}`),o([])})}else{if(null===this._symbolsStorage)throw Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(e,r,i,30).then(o).catch(o.bind(null,[]))}}resolveSymbol(e,r,i,o){let n=o&&o.currencyCode,a=o&&o.unitId;function u(e){r(e)}if(this._configuration.supports_group_request){if(null===this._symbolsStorage)throw Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.resolveSymbol(e,n,a).then(u).catch(i)}else{let l={symbol:e};void 0!==n&&(l.currencyCode=n),void 0!==a&&(l.unitId=a),this._send("symbols",l).then(e=>{void 0!==e.s?i("unknown_symbol"):u(e)}).catch(e=>{t(`UdfCompatibleDatafeed: Error resolving symbol: ${s(e)}`),i("unknown_symbol")})}}getBars(e,t,s,r,i){this._historyProvider.getBars(e,t,s).then(e=>{r(e.bars,e.meta)}).catch(i)}subscribeBars(e,t,s,r,i){this._dataPulseProvider.subscribeBars(e,t,s,r)}unsubscribeBars(e){this._dataPulseProvider.unsubscribeBars(e)}_requestConfiguration(){return this._send("config").catch(e=>(t(`UdfCompatibleDatafeed: Cannot get datafeed configuration - use default, error=${s(e)}`),null))}_send(e,t){return this._requester.sendRequest(this._datafeedURL,e,t)}_setupWithConfiguration(e){if(this._configuration=e,void 0===e.exchanges&&(e.exchanges=[]),!e.supports_search&&!e.supports_group_request)throw Error("Unsupported datafeed configuration. Must either support search, or support group request");(e.supports_group_request||!e.supports_search)&&(this._symbolsStorage=new o(this._datafeedURL,e.supported_resolutions||[],this._requester)),t(`UdfCompatibleDatafeed: Initialized with ${JSON.stringify(e)}`)}}function l(){return{supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M",],supports_marks:!1,supports_timescale_marks:!1}}e.UDFCompatibleDatafeed=class e extends u{constructor(e,t=1e4){let r=new class e{constructor(e){e&&(this._headers=e)}sendRequest(e,t,s){if(void 0!==s){let r=Object.keys(s);0!==r.length&&(t+="?"),t+=r.map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(s[e].toString())}`).join("&")}let i={credentials:"same-origin"};if(void 0!==this._headers&&(i.headers=this._headers),0===e.indexOf("/api/")){let o=window.localStorage.getItem("ACCESS_TOKEN")||"";void 0===i.headers&&(i.headers=new Headers),i.headers.set("Authorization",`Taoniu ${o}`)}return fetch(`${e}/${t}`,i).then(e=>e.text()).then(e=>JSON.parse(e))}},i=new class e{constructor(e,t){this._datafeedUrl=e,this._requester=t}getQuotes(e){return new Promise((t,r)=>{this._requester.sendRequest(this._datafeedUrl,"quotes",{symbols:e}).then(e=>{"ok"===e.s?t(e.d):r(e.errmsg)}).catch(e=>{let t=s(e);r(`network error: ${t}`)})})}}(e,r);super(e,i,r,t)}},Object.defineProperty(e,"__esModule",{value:!0})});
